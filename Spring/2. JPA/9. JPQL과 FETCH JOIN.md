# π“ μ¤ν”„λ§ - κ°μ²΄μ§€ν–¥ μΏΌλ¦¬ μ–Έμ–΄ JPQL - FETCH JOIN

> π’΅ μ—°κ΄€λ μ—”ν‹°ν‹°λ” μ¦‰μ‹ ν• λ²μ— ν•¨κ» μ΅°νν•κ³  μ‹¶μ„ λ• μ‚¬μ©ν•©λ‹λ‹¤. μ§€μ—° λ΅λ”©μΌλ΅ μΈν•΄ N+1 λ¬Έμ κ°€ λ°μƒν•  μ μλ” μƒν™©μ— μ΄λ¥Ό ν•΄κ²°ν•κΈ° μ„ν•΄ μ‚¬μ©ν•©λ‹λ‹¤.

## π‘ΎJPQL 
> ν…μ΄λΈ”μ΄ μ•„λ‹ κ°μ²΄λ¥Ό λ€μƒμΌλ΅ κ²€μƒ‰ν•λ” κ°μ²΄μ§€ν–¥ μΏΌλ¦¬λΌκ³  ν•λ‹¤.
* `JPQL`(**Java Persistence Query Language**)μ€ μ—”ν‹°ν‹° κ°μ²΄λ¥Ό μ΅°νν•λ” κ°μ²΄μ§€ν–¥ μΏΌλ¦¬μ΄λ‹¤.
* `JPQL`μ€ `SQL`μ„ μ¶”μƒν™”ν•΄μ„ νΉμ • λ°μ΄ν„°λ² μ΄μ¤μ— μμ΅΄ν•μ§€ μ•λ”λ‹¤.
* `JPQL`μ€ `SQL`λ³΄λ‹¤ κ°„κ²°ν•λ‹¤. μ—”ν‹°ν‹° μ§μ ‘ μ΅°ν, λ¬µμ‹μ  μ΅°μΈ, λ‹¤ν•μ„± μ§€μ›μΌλ΅ `SQL`λ³΄λ‹¤ μ½”λ“κ°€ κ°„κ²°ν•λ‹¤.

## π•ΈκΈ°λ³Έ λ¬Έλ²•κ³Ό μΏΌλ¦¬ API
* JPQLμ€ SQLκ³Ό λΉ„μ·ν•κ² `SELECT`, `UPDATE`, `DELETE` λ¬Έμ„ μ‚¬μ©ν•  μ μμ§€λ§ `INSERT`λ” μ—†λ‹¤.
* μ—”ν‹°ν‹°λ¥Ό μ €μ¥ν•  λ•λ” `EntityManager.persist()`λ©”μ†λ“λ¥Ό μ‚¬μ©ν•λ©΄ λλ‹¤.

### `SELECT` λ¬Έ μμ‹
```oracle
SELECT m FROM Member AS m where m.username = β€™Hello'
```
* λ€μ†λ¬Έμ κµ¬λ¶„
  * μ—”ν‹°ν‹°μ™€ μ†μ„±μ€(Member, username) λ€μ†λ¬Έμλ¥Ό κµ¬λ¶„ν•μ§€λ§, `SELECT`, `FROM`κ³Ό κ°™μ€ JPQL ν‚¤μ›λ“λ” λ€μ†λ¬Έμλ¥Ό κµ¬λ¶„ν•μ§€ μ•λ”λ‹¤.
* μ—”ν‹°ν‹° μ΄λ¦„ 
  * μ—”ν‹°ν‹° λ…μ€ `@Entity(name="xxx")` λ΅ μ§€μ •ν• κ°’μ„ μ‚¬μ©ν•κ±°λ‚, ν΄λμ¤ λ…μ„ κΈ°λ³ΈμΌλ΅ μ‚¬μ©ν•λ‹¤.
* λ³„ν•‘μ€ ν•„μ 
  * `Member AS m`μ—μ„ `Member`μ— `m`μ΄λΌλ” λ³„μΉ­μ„ μ¤€λ‹¤. JPQLμ€ λ³‘μΉ­μ„ ν•„μλ΅ μ‚¬μ©ν•΄μ•Ό ν•λ‹¤.

## π¥TypeQuery, Query
* μ‘μ„±ν• JPQLμ„ μ‹¤ν–‰ν•λ ¤λ©΄ μΏΌλ¦¬ κ°μ²΄λ¥Ό λ§λ“¤μ–΄μ•Ό ν•λ‹¤.
* μΏΌλ¦¬ κ°μ²΄μ λ°ν™ νƒ€μ…μ΄ λ…ν™•ν•λ©΄ `TypeQuery` κ°μ²΄λ¥Ό μ‚¬μ© 
* λ°ν™ νƒ€μ…μ΄ λ…ν™•ν•μ§€ μ•μΌλ©΄ `Query` κ°μ²΄λ¥Ό μ‚¬μ©ν•λ‹¤.

### TypeQuery μ‚¬μ©
* `em.createQuery`μ λ‘ λ²μ§Έ νλΌλ―Έν„°μ— λ°ν™ν•  νƒ€μ…μ„ μ§€μ •ν•λ©΄ `TypeQuery`λ°ν™ν•κ³  μ§€μ •ν•μ§€ μ•μΌλ©΄ `Query`λ¥Ό λ°ν™ν•λ‹¤.
* μ•„λ μ½”λ“λ” λ°ν™ νƒ€μ…μ΄ `Member`μ—”ν‹°ν‹°μ΄λ―€λ΅ μ΅°νλ€μƒ νƒ€μ…μ΄ λ…ν™•ν•λ‹¤.
```java
TypedQuery<Member> query = em.createQuery ("SELECT m FROM Member m" , Member.class);
List<Member> resultList = query.getResultList();
for (Member member : resultList) {
    System.out.printIn("member = " + member);
}
```
### Query μ‚¬μ© 
* μ΅°ν λ€μƒμ΄ `String`νƒ€μ…μΈ μ΄λ¦„κ³Ό `Integer`νƒ€μ…μΈ λ‚μ΄μ΄λ―€λ΅ μ΅°ν λ€μƒ νƒ€μ…μ΄ λ…ν™•ν•μ§€ μ•λ‹¤.
* μ΄μ²λΌ `SELECT`μ μ—μ„ μ—¬λ¬ μ—”ν‹°ν‹°λ‚ μ»¬λΌμ„ μ„ νƒν•  λ• λ°ν™ νƒ€μ…μ΄ λ…ν™•ν•μ§€ μ•μ•„ `Query`κ°μ²΄λ¥Ό μ‚¬μ©
* `Query`κ°μ²΄λ” μ΅°ν λ€μƒμ΄ λ‘κ° μ΄μƒμ΄λ©΄ `Object[]`λ¥Ό λ°ν™ν•κ³  μ΅°ν λ€μƒμ΄ ν•λ‚μ΄λ©΄ `Object`λ¥Ό λ°ν™ν•λ‹¤.
```java
Query query = em.createQuery("SELECT m.username, m.age from Member m");
List resultList = query.getResultList();
for (Object o : resultList) {
    //κ²°κ³Όκ°€ λ‘ μ΄μƒμ΄λ©΄ Object [] λ°ν™
    Object[] result = (Object []) o;
    System.out.printin("username = " + result[0]);
    System.out.printin("age = " + result[1]);
}
```
### κ²°κ³Ό μ΅°ν
* `query.getResultList()` : κ²°κ³Όλ¥Ό μμ λ΅ λ°ν™ν•λ‹¤. μ—†μ„ κ²½μ° λΉ μ»¬λ ‰μ…μ„ λ°ν™ν•λ‹¤. 
* `query.getSingleResult()` : κ²°κ³Όκ°€ μ •ν™•ν ν•λ‚μΌ λ• μ‚¬μ©ν•λ‹¤. 
  * κ²°κ³Όκ°€ μ—†κ±°λ‚ 1κ°λ³΄λ‹¤ λ§μΌλ©΄ μμ™Έκ°€ λ°μƒν•λ‹¤.

## π„νλΌλ―Έν„° λ°”μΈλ”© 
> JDBCλ” μ„μΉ κΈ°μ¤€ νλΌλ―Έν„° λ°”μΈλ”©λ§ μ§€μ›ν•μ§€λ§ JPQLμ€ μ΄λ¦„ κΈ°μ¤€ νλΌλ―Έν„° λ°”μΈλ™ μ§€μ›ν•λ‹¤.

### μ΄λ¦„ κΈ°μ¤€ νλΌλ―Έν„° 
* μ΄λ¦„ κΈ°μ¤€ νλΌλ―Έν„°λ” μ•μ— :λ¥Ό μ‚¬μ©ν•λ‹¤.
* `:username`μ΄λΌλ” μ΄λ¦„ κΈ°μ¤€ νλΌλ―Έν„°λ¥Ό μ •μν•κ³  `query.setParameter`μ—μ„ νλΌλ―Έν„°λ¥Ό λ°”μΈλ”©ν•λ‹¤.
* `JPQL API`λ” λ€λ¶€λ¶„ λ©”μ†λ“ μ²΄μΈ λ°©μ‹μΌλ΅ μ„¤κ³„λμ–΄μμ–΄ μ—°μ†ν•΄μ„ μ‘μ„±ν•  μ μλ‹¤.
```java
TypedQuery<Member> query = em.createQuery("SELECT m FROM Member m where m.username = :username", Member.class);
query.setParameter("username", usernameParam);

// λλ” λ©”μ„λ“ μ²΄μΈμ„ μ‚¬μ©ν•λ‹¤.
query = em.createQuery("SELECT m FROM Member m where m.username = :username", Member.class)
    .setParameter("usernameβ€, usernameParam);
```
### μ„μΉ κΈ°μ¤€ νλΌλ―Έν„° 
* μ„μΉ κΈ°μ¤€ νλΌλ―Έν„°λ” ?λ‹¤μμ— μ„μΉ κ°’μ„ μ£Όλ©΄ λλ‹¤. 
* μ„μΉ κ°’μ€ 1λ¶€ν„° μ‹μ‘ν•λ‹¤.
> μ„μΉ κΈ°μ¤€ νλΌλ―Έν„° λ°©μ‹λ³΄λ‹¤λ” μ΄λ¦„ κΈ°μ¤€ νλΌλ―Έν„° λ°”μΈλ”© λ°©μ‹μ„ μ‚¬μ©ν•λ” κ²ƒμ΄ λ…ν™•ν•λ‹¤.
```java
List<Member> members = em.createQuery("SELECT m FROM Member m where m.username = ?1", Member.class)
    .setParameter(1, usernameParam).getResultList();
```

## π“νμ΄μ§• API
* JPAλ” νμ΄μ§•μ„ λ‘ APIλ΅ μ¶”μƒν™”ν–λ‹¤.
* `setFirstResult (int startPosition)` : μ΅°ν μ‹μ‘ μ„μΉ(0λ¶€ν„° μ‹μ‘ν•λ‹¤)
* `setMaxResults (int maxResult)` : μ΅°νν•  λ°μ΄ν„° μ
* `FirstResult`μ μ‹μ‘μ€ 10μ΄λ―€λ΅ 11λ¶€ν„° μ‹μ‘ν•λ‹¤. μ΄ 20κ±΄μ λ°μ΄ν„°λ¥Ό μ΅°νν•λ‹¤.
* λ”°λΌμ„ 11 ~ 30λ² λ°μ΄ν„°λ¥Ό μ΅°νν•λ‹¤.
```java
TypedQuery<Member> query = em.createQuery("SELECT m FROM Member m ORDER BY m.username DESC", Member.class);
query.setFirstResult(10);
query.setMaxResults(20);
query.getResultList();
```

## π¥νμΉ μ΅°μΈ 
* νμΉ μ΅°μΈμ€ SQLμ—μ„ μ‚¬μ©ν•λ” μ΅°μΈμ μΆ…λ¥λ” μ•„λ‹κ³  JPQLμ—μ„ μ„±λ¥ μµμ ν™”λ¥Ό μ„ν•΄ μ κ³µν•λ” κΈ°λ¥μ΄λ‹¤. 
* μ—°κ΄€λ μ—”ν‹°ν‹°λ‚ μ»¬λ ‰μ…μ„ ν• λ²μ— κ°™μ΄ μ΅°νν•λ” κΈ°λ¥μΌλ΅ join fetch λ…λ Ήμ–΄λ΅ μ‚¬μ©ν•λ‹¤.

### μ—”ν‹°ν‹° νμΉ μ΅°μΈ 
* νμΉ μ΅°μΈμ€ μ—°κ΄€λ μ—”ν‹°ν‹°λ‚ μ»¬λ ‰μ…μ„ ν•¨κ» μ΅°νν•λ‹¤. μ•„λ μ½”λ“λ” νμ›(`m`)κ³Ό ν€(`m.team`)μ„ ν•¨κ» μ΅°νν–λ‹¤. 
* μΌλ°μ μΈ JPQL μ΅°μΈκ³Όλ” λ‹¤λ¥΄κ² `m.team`λ’¤μ— λ³‘μΉ­μ΄ μ—†λ”λ° νμΉ μ΅°μΈμ€ λ³„μΉ­μ„ μ‚¬μ©ν•  μ μ—†λ‹¤.
> νμΉ μ΅°μΈμ€ λ³„μΉ­μ„ μ‚¬μ©ν•  μ μ—†λ‹¤. ν•μ΄λ²„λ„¤μ΄νΈλ” λ³„μΉ­μ„ ν—μ©ν•λ‹¤.
```java
select m from Member m join fetch m.team
```
```oracle
SELECT
    M.*, T.*
FROM MEMBER M
INNER JOIN TEAM T ON M.TEAM_ID=T.ID
```
* νμΉ μ΅°μΈ JPQLμ—μ„ `select m`μΌλ΅ νμ› μ—”ν‹°ν‹°λ§ μ„ νƒν–λ”λ° μ‹¤ν–‰λ SQLμ„(`M.*`, `T.*`) λ³΄λ©΄ μ—°κ΄€λ ν€ μ—”ν‹°ν‹° ν•¨κ» μ΅°νλμ—λ‹¤.
* μ•„λ μ΄λ―Έμ§€λ¥Ό λ³΄λ©΄ νμ›κ³Ό ν€ κ°μ²΄κ°€ κ°μ²΄ κ·Έλν”„λ¥Ό μ μ§€ν•λ©΄μ„ μ΅°ν λ κ²ƒμ„ μ• μ μλ‹¤.

<img width="492" alt="Image" src="https://github.com/user-attachments/assets/ef64f250-f313-4a98-97cc-9ad4615e5674" />

> λ§μ•½ μ—°κ΄€κ΄€κ³„μ—μ„ `fetch=FetchType.LAZY` μ™€ κ°™μ΄ μ§€μ—° λ΅λ”©μ„ μ„¤μ •ν•λ”λΌλ„ νμΉ μ΅°μΈμ„ μ‚¬μ©ν•λ©΄ ν€λ„ ν•¨κ» μ΅°νν–μΌλ―€λ΅
ν€ μ—”ν‹°ν‹°λ” ν”„λ΅μ‹κ°€ μ•„λ‹ μ‹¤μ  μ—”ν‹°ν‹°μ΄λ‹¤. λ”°λΌμ„ μ—°κ΄€λ ν€μ„ μ‚¬μ©ν•΄λ„ μ§€μ—° λ΅λ”©μ΄ μΌμ–΄λ‚μ§€ μ•λ”λ‹¤.

## π¥¤μ»¬λ ‰μ… νμΉ μ΅°μΈ 
* μΌλ€λ‹¤ κ΄€κ³„μΈ μ»¬λ ‰μ…μ„ νμΉ μ΅°μΈν•λ©΄ λ‹¤μκ³Ό κ°™λ‹¤.
```oracle
select t
from Team t join fetch t.members
where t.name = 'ν€A'
```
````oracle
SELECT
    T.*, M.*
FROM TEAM T
INNER JOIN MEMBER M ON T.ID=M.TEAM_ID
WHERE T.NAME = 'ν€A'
````
* ν€Aλ” ν•λ‚μ§€λ§ `Memeber` ν…μ΄λΈ”κ³Ό μ΅°μΈν•λ©΄μ„ κ²°κ³Όκ°€ μ¦κ°€ν•΄μ„ ν€Aλ” 2κ±΄ μ΅°νλλ‹¤.
* μ¦‰, `Team`μ€ ν•λ‚μ§€λ§, `join fetch t.members`λ΅ μΌλ€λ‹¤ μ΅°μΈμ„ κ±Έμ—κΈ° λ•λ¬Έμ— 
* `κ°™μ€ ν€ κ°μ²΄ + λ‹¤λ¥Έ λ©¤λ²„ λ‘ κ°` κ²°κ³Όμ μΌλ΅ `Team` κ°μ²΄κ°€ μ¤‘λ³µλμ–΄ λ³΄μΈλ‹¤.
> νΉν, μΌλ€λ‹¤ μ΅°μΈμ—μ„ κ²°κ³Όκ°€ μ¦κ°€ν•λ‹¤. (μΌλ€μΌ, λ‹¤λ€μΌ μ΅°μΈμ€ κ²°κ³Όκ°€ μ¦κ°€ν•μ§€ μ•λ”λ‹¤.)

![Image](https://github.com/user-attachments/assets/8dbfa8d2-64ca-465c-9e3e-53e43af1c9f4)

## π¥ƒνμΉ μ΅°μΈκ³Ό DISTINCT
* μ„μ™€ κ°™μ΄ μ¤‘λ³µμ κ²½μ°λ¥Ό μ κ±°ν•κΈ° μ„ν•΄ DISTINCT λ…λ Ήμ–΄λ¥Ό μ‚¬μ©ν•λ‹¤.
* JPQLμ DISTINCT λ…λ Ήμ–΄λ” SQLμ— DISTINCTλ¥Ό μ¶”κ°€ν•κ³  μ• ν”λ¦¬μΌ€μ΄μ…μ—μ„ ν• λ² λ” μ¤‘λ³µμ„ μ κ±°ν•λ‹¤.

```oracle
select distinct t
from Team t join fetch t.members
where t.name = 'ν€A'
```

