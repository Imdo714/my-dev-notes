# π“ Spring - Redisson λ¶„μ‚°λ½

> π’΅ Redissonμ€ pub/sub μ±„λ„μ„ κµ¬λ…ν•΄ λ½ ν•΄μ  μ•λ¦Όμ„ κΈ°λ‹¤λ Έλ‹¤κ°€ μ•λ¦Όμ΄ μ¤λ©΄ λ‹¤μ‹ μ”μ²­μ„ λ³΄λƒ…λ‹λ‹¤.

## πRedisson μ΄λ€?
* `Redisson`μ€ λ½ νλ“ μ‹ μ¤ν•€ λ½ λ°©μ‹μ΄ μ•„λ‹ `pub/sub` λ°©μ‹μ„ μ΄μ©ν•λ‹¤.
* `pub/sub` λ°©μ‹μ€ λ½μ΄ ν•΄μ λ  λ•λ§λ‹¤ `subscribe`μ¤‘μΈ ν΄λΌμ΄μ–ΈνΈμ—κ² "**μ΄μ  λ½ νλ“μ„ μ‹λ„ν•΄λ„ λλ‹¤.**"λΌλ” μ•λ¦Όμ„ λ³΄λ‚΄κΈ° λ•λ¬Έμ—
* ν΄λΌμ΄μ–ΈνΈμ—μ„ λ½ νλ“μ„ μ‹¤ν¨ν–μ„ λ•, `redis`μ— μ§€μ†μ μΌλ΅ λ½ νλ“ μ”μ²­μ„ λ³΄λ‚΄λ” κ³Όμ •μ΄ μ‚¬λΌμ§€κ³ , μ΄μ— λ”°λΌ λ¶€ν•κ°€ λ°μƒν•μ§€ μ•κ² λλ‹¤. 
* λν• `Redisson`μ€ `RLock`μ΄λΌλ” λ½μ„ μ„ν• μΈν„°νμ΄μ¤λ¥Ό μ κ³µν•λ‹¤. μ΄ μΈν„°νμ΄μ¤λ¥Ό μ΄μ©ν•μ—¬ λΉ„κµμ  μ†μ‰½κ² λ½μ„ μ‚¬μ©ν•  μ μλ‹¤.

<img width="879" height="223" alt="Image" src="https://github.com/user-attachments/assets/9bd5d864-c8b4-4e90-a422-47da37e6acb1" />

## π‘½Redisson μμ΅΄μ„± 
* `Redisson`μμ΅΄μ„±μ„ λ°›μµλ‹λ‹¤.
```java
dependencies {
    implementation 'org.redisson:redisson-spring-boot-starter:3.17.4'
}
```
## π’»μμ‹ μ½”λ“
1. `getLock(key)`λ¥Ό μ‚¬μ©ν•΄μ„ λ½ κ°μ²΄λ¥Ό κ°€μ Έμµλ‹λ‹¤.
2. `tryLock()`μ„ νΈμ¶ν•λ©΄ λ½μ„ μ‹λ„ν•κ³  μ΄λ―Έ λ‹¤λ¥Έ μ“°λ λ“κ°€ λ½μ„ λ³΄μ  μ¤‘μ΄λ©΄ `Redisson`μ€ λ‚΄λ¶€μ μΌλ΅ `Redis pub/sub`μ±„λ„μ„ κµ¬λ…(`subscribe`) ν•©λ‹λ‹¤
3. μ΄λ• `tryLock()`μ— μ„¤μ •ν• μµλ€ λ€κΈ° μ‹κ°„λ§νΌ λ½μ„ μ΅μΌλ ¤κ³  λ€κΈ°ν•©λ‹λ‹¤.
4. λ½μ„ λ³΄μ  μ¤‘μΈ μ“°λ λ“κ°€ `unlock()`μ„ νΈμ¶ν•λ©΄, `Redisson`μ€ ν•΄λ‹Ή `pub/sub`μ±„λ„μ— λ½ ν•΄μ  λ©”μ‹μ§€λ¥Ό `publish`ν•©λ‹λ‹¤.
5. λ€κΈ° μ¤‘μ΄λ `Redisson` ν΄λΌμ΄μ–ΈνΈλ“¤μ€ μ΄ λ©”μ‹μ§€λ¥Ό μμ‹ ν•κ³  λ‹¤μ‹ λ½μ„ μ‹λ„ν•©λ‹λ‹¤.
6. λ½μ„ λ¨Όμ € νλ“ν• ν΄λΌμ΄μ–ΈνΈλ§ μ‘μ—…μ„ μν–‰ν•κ³  μ‘μ—…μ΄ λλ‚λ©΄ `unlock()`μΌλ΅ λ½μ„ ν•΄μ ν•©λ‹λ‹¤.

```java
@Component
@RequiredArgsConstructor
public class RedissonLockStockFacade {

    private RedissonClient redissonClient;
    private StockService stockService;

    public void decrease(Long key, Long quantity) {
        RLock lock = redissonClient.getLock(key.toString());

        try {
            boolean available = lock.tryLock(10, 1, TimeUnit.SECONDS);

            if (!available) {
                System.out.println("lock νλ“ μ‹¤ν¨");
                return;
            }

            stockService.decrease(key, quantity);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        } finally {
            lock.unlock();
        }
    }

}
```

* `RedissonClient`λ” Redis μ„λ²„μ™€ μ—°κ²°ν•΄μ£Όλ” κ°μ²΄μ…λ‹λ‹¤.
* μ΄λ• `Redisson`μ—μ„ λ‚΄λ¶€μ μΌλ΅ `pub/sub` μ±„λ„μ€ λ‚΄λ¶€μ μΌλ΅ μλ™ μ„¤μ • ν•΄μ¤λ‹λ‹¤.
* Redisλ¥Ό λ¶„μ‚° λ½ μ©λ„λ΅ μ‚¬μ©ν•  μ μκ² ν•΄μ£Όλ” μ—­ν• μ„ ν•λ©° `getLock()`λ©”μ„λ“λ¥Ό ν†µν•΄ λ½μ„ λ§λ“¤κ³  μ‚¬μ©ν•  μ μκ² ν•΄μ¤λ‹λ‹¤.
* μ¦‰, μ—¬λ¬ μ„λ²„λ‚ μ—¬λ¬ μ“°λ λ“κ°€ λ™μ‹μ— μ ‘κ·Όν•  λ• ν• λ²μ— ν• μ“°λ λ“λ§ μ‹¤ν–‰λλ„λ΅ μ μ•„ν•λ” μ—­ν• μ„ ν•©λ‹λ‹¤. 
```java
RLock lock = redissonClient.getLock(key.toString());
```
---
* `tryLock`μ€ λ‡μ΄ λ™μ• λ½ νλ“μ„ μ‹λ„ν• κ»€μ§€ μ„¤μ •ν•λ” λ©”μ„λ“μ…λ‹λ‹¤.
* `waitTime`: λ½ νλ“μ„ μ„ν•΄ κΈ°λ‹¤λ¦¬λ” μ‹κ°„
* `leaseTime`: λ½μ„ μ„λ€ν•λ” μ‹κ°„
* `timeUnit`: μ‹κ°„ λ‹¨μ„
* μ΄ μ„¤μ •μ— λ”°λΌ λ½ νλ“μ„ μ”μ²­ν–μ„ λ• λ½μ„ νλ“ν•  μ μ—†λ‹¤λ©΄ `waitTime`λ§νΌ κΈ°λ‹¤λ¦¬κ³ 
* λ½μ„ νλ“ν–λ‹¤λ©΄, μµλ€ `leaseTime`λ§νΌ λ½μ„ μ μ ν•  μ μλ‹¤.
```java
boolean tryLock(long waitTime, long leaseTime, TimeUnit timeUnit) throws InterruptedException;
```

* λ½μ΄ μ΅ν€μλ‹¤λ©΄ `Redisson`μ΄ ν•΄λ‹Ή μ±„λ„μ„ λ‚΄λ¶€μ μΌλ΅ κµ¬λ…μ„ ν•©λ‹λ‹¤. 
* λ½μ„ μ΅μ•μΌλ©΄ `stockService.decrease()`λ©”μ„λ“λ¥Ό μ‹¤ν–‰ ν•΄ μƒν’μ„ 1κ°μ†μ‹ν‚¨ ν›„ `lock.unlock()`μ„ μ΄μ©ν•΄ λ½μ„ ν•΄μ  ν•λ‹¤.
* μ΄ λ½μ€ Redisμ— μ €μ¥λκ³  λ™μ‹μ— ν• μ”μ²­λ§ μ¬κ³ λ¥Ό μ¤„μΌ μ μλ„λ΅ λ³΄μ¥ν•΄μ¤€λ‹¤.
* 10μ΄ λ™μ• λ½μ„ μ΅μ§€ λ»ν•λ©΄ `"lock νλ“ μ‹¤ν¨"`λΌλ” λ΅κ·Έλ¥Ό λ‚¨κΈ°κ³  λ½μ„ ν—¤μ ν•κ³  λμ΄ λ‚λ‹¤.
```java
try {
    boolean available = lock.tryLock(10, 1, TimeUnit.SECONDS);
    
    if (!available) {
        System.out.println("lock νλ“ μ‹¤ν¨");
        return;
    }
    
    stockService.decrease(key, quantity);
} catch (InterruptedException e) {
    throw new RuntimeException(e);
} finally {
    lock.unlock();
}
```
